---
# Fluentd 1.19 StatefulSet (Separate from Wazuh Manager)
# This creates a standalone Fluentd deployment per client namespace
# OpenSearch compatible - no license check issues

- name: "Create {{ ansible_k8s_namespace }} Fluentd service (headless)"
  k8s:
    validate_certs: false
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    state: present
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: fluentd
        namespace: "{{ ansible_k8s_namespace }}"
        labels:
          app: fluentd
          client: "{{ ansible_k8s_namespace }}"
      spec:
        type: ClusterIP
        clusterIP: None
        selector:
          app: fluentd
        ports:
        - name: netflow
          port: 2055
          targetPort: 2055
          protocol: UDP
        - name: sflow
          port: 6343
          targetPort: 6343
          protocol: UDP
        - name: mikrotik
          port: 40514
          targetPort: 40514
          protocol: UDP
        - name: fortigate-cef
          port: 40515
          targetPort: 40515
          protocol: TCP
        - name: fortigate-syslog
          port: 40516
          targetPort: 40516
          protocol: UDP
        - name: cisco-asa
          port: 40517
          targetPort: 40517
          protocol: UDP
        - name: palo-alto
          port: 40518
          targetPort: 40518
          protocol: TCP
        - name: syslog-udp
          port: 40519
          targetPort: 40519
          protocol: UDP
        - name: syslog-tcp
          port: 40520
          targetPort: 40520
          protocol: TCP
        - name: cef-tcp
          port: 40521
          targetPort: 40521
          protocol: TCP
        - name: cef-udp
          port: 40522
          targetPort: 40522
          protocol: UDP
        - name: ruckus-udp
          port: 40523
          targetPort: 40523
          protocol: UDP
        - name: ruckus-tcp
          port: 40524
          targetPort: 40524
          protocol: TCP
        - name: checkpoint-cef
          port: 40525
          targetPort: 40525
          protocol: TCP
        - name: checkpoint-syslog
          port: 40526
          targetPort: 40526
          protocol: UDP

# NodePort service removed - using hostPort in StatefulSet instead
# This allows each client node to use the same port (30154) since pods are scheduled on different nodes

- name: "Create {{ ansible_k8s_namespace }} Fluentd StatefulSet"
  k8s:
    validate_certs: false
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    state: present
    definition:
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: fluentd
        namespace: "{{ ansible_k8s_namespace }}"
        labels:
          app: fluentd
          client: "{{ ansible_k8s_namespace }}"
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: fluentd
        serviceName: fluentd
        template:
          metadata:
            labels:
              app: fluentd
              client: "{{ ansible_k8s_namespace }}"
          spec:
            # Use host network to bind directly to node's ports
            hostNetwork: true
            dnsPolicy: ClusterFirstWithHostNet
            
            nodeSelector:
              wazuh-client-id: "{{ ansible_k8s_namespace }}"
            
            tolerations:
            - key: "node.kubernetes.io/disk-pressure"
              operator: "Exists"
              effect: "NoSchedule"
            
            imagePullSecrets:
            - name: "{{ image_pull_secret_name }}"
            
            volumes:
            - name: fluentd-buffer
              emptyDir: {}
            
            containers:
            - name: fluentd
              image: "ghcr.io/anki-security/wazuh-fluentd:latest"
              imagePullPolicy: Always
              resources:
                requests:
                  cpu: "{{ fluentd_cpu_request | default('100m') }}"
                  memory: "{{ fluentd_memory_request | default('256Mi') }}"
                limits:
                  cpu: "{{ fluentd_cpu_limit | default('500m') }}"
                  memory: "{{ fluentd_memory_limit | default('512Mi') }}"
              securityContext:
                runAsUser: 0
                capabilities:
                  add:
                  - NET_BIND_SERVICE
              volumeMounts:
              - name: fluentd-buffer
                mountPath: /fluentd/buffer
              - name: fluentd-data
                mountPath: /fluentd/log
              ports:
              - containerPort: 2055
                name: netflow
                protocol: UDP
              - containerPort: 6343
                name: sflow
                protocol: UDP
              - containerPort: 40514
                name: mikrotik
                protocol: UDP
              - containerPort: 40515
                name: forti-cef
                protocol: TCP
              - containerPort: 40516
                name: forti-syslog
                protocol: UDP
              - containerPort: 40517
                name: cisco-asa
                protocol: UDP
              - containerPort: 40518
                name: palo-alto
                protocol: TCP
              - containerPort: 40519
                name: syslog-udp
                protocol: UDP
              - containerPort: 40520
                name: syslog-tcp
                protocol: TCP
              - containerPort: 40521
                name: cef-tcp
                protocol: TCP
              - containerPort: 40522
                name: cef-udp
                protocol: UDP
              - containerPort: 40523
                name: ruckus-udp
                protocol: UDP
              - containerPort: 40524
                name: ruckus-tcp
                protocol: TCP
              - containerPort: 40525
                name: chkpoint-cef
                protocol: TCP
              - containerPort: 40526
                name: chkpoint-syslog
                protocol: UDP
              env:
              - name: TZ
                value: "{{ client_timezone | default(default_timezone) | default('UTC') }}"
              - name: INDEXER_HOST
                value: "wazuh-indexer.{{ ansible_k8s_namespace }}.svc.cluster.local"
              - name: INDEXER_PORT
                value: "9200"
              - name: INDEXER_USERNAME
                valueFrom:
                  secretKeyRef:
                    name: indexer-cred
                    key: INDEXER_USERNAME
              - name: INDEXER_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: indexer-cred
                    key: INDEXER_PASSWORD
              - name: SETUP_PIPELINES
                value: "true"
              - name: FLUENTD_LOG_LEVEL
                value: "{{ fluentd_log_level | default('info') }}"
              - name: NODE_NAME
                valueFrom:
                  fieldRef:
                    fieldPath: spec.nodeName
              - name: POD_NAME
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.name
              - name: POD_NAMESPACE
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.namespace
        
        volumeClaimTemplates:
        - metadata:
            name: fluentd-data
            namespace: "{{ ansible_k8s_namespace }}"
          spec:
            accessModes:
            - ReadWriteOnce
            storageClassName: "{{ fluentd_storage_class | default('local-path') }}"
            resources:
              requests:
                storage: "{{ fluentd_storage_size | default('2Gi') }}"
