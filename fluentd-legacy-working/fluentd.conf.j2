###################### Fluentd Configuration ######################
# Fluentd configuration for MikroTik syslog collection
# Version: 1.19 (OpenSearch compatible)

# System configuration
<system>
  log_level info
  workers 1
</system>

# Source: UDP Syslog input for MikroTik
# Using raw UDP input instead of syslog parser for better compatibility
<source>
  @type udp
  port 30514
  bind 0.0.0.0
  tag mikrotik.syslog
  source_address_key source_ip
  <parse>
    @type none
  </parse>
</source>

# Filter: Add metadata and enrich
<filter mikrotik.**>
  @type record_transformer
  enable_ruby true
  <record>
    log_source mikrotik
    vendor mikrotik
    product routeros
    hostname ${record["source_ip"] || "unknown"}
    "@timestamp" ${time.strftime('%Y-%m-%dT%H:%M:%S.%LZ')}
  </record>
</filter>

# Topic extraction removed - let Grok pipeline handle all parsing
# <filter mikrotik.**>
#   @type parser
#   key_name message
#   reserve_data true
#   <parse>
#     @type regexp
#     expression /^(?<topic>[^\s]+)\s+(?<log_message>.*)$/
#   </parse>
# </filter>

# Match: Send to OpenSearch/Wazuh Indexer
<match mikrotik.**>
  @type opensearch
  
  # Connection settings
  host wazuh-indexer.{{ ansible_k8s_namespace }}.svc.cluster.local
  port 9200
  scheme https
  ssl_verify false
  ssl_version TLSv1_2
  
  # Authentication
  user "#{ENV['ELASTICSEARCH_USERNAME']}"
  password "#{ENV['ELASTICSEARCH_PASSWORD']}"
  
  # Index settings
  index_name mikrotik-routeros-%Y.%m.%d
  type_name _doc
  
  # Pipeline - use existing Grok pipeline in OpenSearch for advanced parsing
  pipeline mikrotik-routeros
  
  # Buffering
  <buffer tag, time>
    @type file
    path /fluentd/buffer/opensearch
    timekey 60s
    timekey_wait 10s
    flush_mode interval
    flush_interval 10s
    retry_type exponential_backoff
    retry_wait 1s
    retry_max_interval 60s
    retry_timeout 1h
    flush_at_shutdown true
    chunk_limit_size 8MB
    total_limit_size 512MB
    overflow_action drop_oldest_chunk
  </buffer>
  
  # Error handling
  <secondary>
    @type file
    path /fluentd/failed_records
  </secondary>
</match>
