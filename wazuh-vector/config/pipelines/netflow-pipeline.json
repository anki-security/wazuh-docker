{
  "description": "NetFlow/IPFIX processing pipeline",
  "processors": [
    {
      "set": {
        "field": "event.kind",
        "value": "event"
      }
    },
    {
      "set": {
        "field": "event.category",
        "value": ["network"]
      }
    },
    {
      "set": {
        "field": "event.type",
        "value": ["connection", "protocol"]
      }
    },
    {
      "rename": {
        "field": "netflow.ipv4_src_addr",
        "target_field": "source.ip",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "rename": {
        "field": "netflow.ipv4_dst_addr",
        "target_field": "destination.ip",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "rename": {
        "field": "netflow.ipv6_src_addr",
        "target_field": "source.ip",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "rename": {
        "field": "netflow.ipv6_dst_addr",
        "target_field": "destination.ip",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "rename": {
        "field": "netflow.l4_src_port",
        "target_field": "source.port",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "rename": {
        "field": "netflow.l4_dst_port",
        "target_field": "destination.port",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "rename": {
        "field": "netflow.protocol",
        "target_field": "network.iana_number",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "rename": {
        "field": "netflow.in_bytes",
        "target_field": "source.bytes",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "rename": {
        "field": "netflow.out_bytes",
        "target_field": "destination.bytes",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "rename": {
        "field": "netflow.in_pkts",
        "target_field": "source.packets",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "rename": {
        "field": "netflow.out_pkts",
        "target_field": "destination.packets",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "script": {
        "lang": "painless",
        "source": "if (ctx.source?.bytes != null && ctx.destination?.bytes != null) { ctx.network = ['bytes': ctx.source.bytes + ctx.destination.bytes]; }",
        "ignore_failure": true
      }
    },
    {
      "script": {
        "lang": "painless",
        "source": "if (ctx.source?.packets != null && ctx.destination?.packets != null) { if (ctx.network == null) { ctx.network = [:]; } ctx.network.packets = ctx.source.packets + ctx.destination.packets; }",
        "ignore_failure": true
      }
    },
    {
      "script": {
        "lang": "painless",
        "source": "def protocols = ['1': 'icmp', '6': 'tcp', '17': 'udp', '47': 'gre', '50': 'esp', '51': 'ah', '58': 'ipv6-icmp']; if (ctx.network?.iana_number != null) { String proto = protocols.get(ctx.network.iana_number.toString()); if (proto != null) { ctx.network.transport = proto; } }",
        "ignore_failure": true
      }
    },
    {
      "convert": {
        "field": "source.port",
        "type": "long",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "convert": {
        "field": "destination.port",
        "type": "long",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "convert": {
        "field": "source.bytes",
        "type": "long",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "convert": {
        "field": "destination.bytes",
        "type": "long",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "convert": {
        "field": "source.packets",
        "type": "long",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "convert": {
        "field": "destination.packets",
        "type": "long",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "set": {
        "field": "observer.type",
        "value": "router"
      }
    }
  ]
}
