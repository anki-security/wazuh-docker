<!--
  NetFlow Security Rules
  
  Rule ID Range: 220001-220099 (NetFlow)
  Detection rules for network flow analysis.
  Covers: port scanning, data exfiltration, DDoS, suspicious protocols
-->

<group name="netflow,network,">

  <!-- Base rule for all NetFlow logs -->
  <rule id="220001" level="0">
    <decoded_as>sensor-netflow-json</decoded_as>
    <field name="log_source">netflow</field>
    <description>NetFlow data.</description>
  </rule>

  <!-- High Volume Traffic -->
  
  <rule id="220010" level="5">
    <if_sid>220001</if_sid>
    <field name="bytes" type="pcre2">\d{9,}</field>
    <description>NetFlow: High volume traffic detected - $(bytes) bytes from $(src_ip) to $(dst_ip)</description>
    <group>traffic_anomaly,</group>
  </rule>

  <rule id="220011" level="8">
    <if_sid>220001</if_sid>
    <field name="bytes" type="pcre2">\d{10,}</field>
    <description>NetFlow: Very high volume traffic - $(bytes) bytes from $(src_ip) to $(dst_ip)</description>
    <group>traffic_anomaly,data_exfiltration,</group>
    <mitre>
      <id>T1048</id>
    </mitre>
  </rule>

  <!-- Port Scanning Detection -->
  
  <rule id="220020" level="7" frequency="50" timeframe="60">
    <if_matched_sid>220001</if_matched_sid>
    <same_source_ip />
    <description>NetFlow: Possible port scan detected - $(frequency_value) connections from $(src_ip)</description>
    <group>recon,port_scan,</group>
    <mitre>
      <id>T1046</id>
    </mitre>
  </rule>

  <rule id="220021" level="10" frequency="100" timeframe="60">
    <if_matched_sid>220001</if_matched_sid>
    <same_source_ip />
    <description>NetFlow: Active port scan detected - $(frequency_value) connections from $(src_ip)</description>
    <group>recon,port_scan,</group>
    <mitre>
      <id>T1046</id>
    </mitre>
  </rule>

  <!-- Suspicious Protocols -->
  
  <rule id="220030" level="8">
    <if_sid>220001</if_sid>
    <field name="dst_port">22</field>
    <field name="dst_ip" type="pcre2" negate="yes">^(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.)</field>
    <description>NetFlow: Outbound SSH connection to external host $(dst_ip):22 from $(src_ip)</description>
    <group>external_connection,ssh,</group>
    <mitre>
      <id>T1048.002</id>
    </mitre>
  </rule>

  <rule id="220031" level="8">
    <if_sid>220001</if_sid>
    <field name="dst_port">21</field>
    <field name="dst_ip" type="pcre2" negate="yes">^(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.)</field>
    <description>NetFlow: Outbound FTP connection to external host $(dst_ip):21 from $(src_ip)</description>
    <group>external_connection,ftp,</group>
    <mitre>
      <id>T1048.002</id>
    </mitre>
  </rule>

  <rule id="220032" level="6">
    <if_sid>220001</if_sid>
    <field name="dst_port">22</field>
    <field name="bytes" type="pcre2">\d{8,}</field>
    <description>NetFlow: High volume SSH traffic - possible data exfiltration via SSH from $(src_ip)</description>
    <group>data_exfiltration,</group>
    <mitre>
      <id>T1048.002</id>
    </mitre>
  </rule>

  <rule id="220033" level="6">
    <if_sid>220001</if_sid>
    <field name="dst_port">443</field>
    <field name="bytes" type="pcre2">\d{9,}</field>
    <description>NetFlow: High volume HTTPS traffic - possible data exfiltration from $(src_ip)</description>
    <group>data_exfiltration,</group>
    <mitre>
      <id>T1048.003</id>
    </mitre>
  </rule>

  <rule id="220034" level="5">
    <if_sid>220001</if_sid>
    <field name="dst_port">53</field>
    <field name="bytes" type="pcre2">\d{6,}</field>
    <description>NetFlow: High volume DNS traffic - possible DNS tunneling from $(src_ip)</description>
    <group>data_exfiltration,dns_tunneling,</group>
    <mitre>
      <id>T1071.004</id>
    </mitre>
  </rule>

  <!-- Uncommon Ports -->
  
  <rule id="220040" level="4">
    <if_sid>220001</if_sid>
    <field name="dst_port" type="pcre2">^(4444|5555|6666|7777|8888|9999)$</field>
    <description>NetFlow: Traffic to suspicious port $(dst_port) from $(src_ip) to $(dst_ip)</description>
    <group>suspicious_port,</group>
    <mitre>
      <id>T1571</id>
    </mitre>
  </rule>

  <rule id="220041" level="6">
    <if_sid>220001</if_sid>
    <field name="dst_port" type="pcre2">^(31337|12345|54321)$</field>
    <description>NetFlow: Traffic to known backdoor port $(dst_port) from $(src_ip) to $(dst_ip)</description>
    <group>backdoor,malware,</group>
    <mitre>
      <id>T1571</id>
    </mitre>
  </rule>

  <!-- Outbound Connection Anomalies -->
  
  <rule id="220060" level="5" frequency="20" timeframe="60">
    <if_matched_sid>220001</if_matched_sid>
    <same_source_ip />
    <field name="dst_port">445</field>
    <description>NetFlow: Multiple SMB connections from $(src_ip) - possible lateral movement</description>
    <group>lateral_movement,smb,</group>
    <mitre>
      <id>T1021.002</id>
    </mitre>
  </rule>

  <rule id="220061" level="5" frequency="20" timeframe="60">
    <if_matched_sid>220001</if_matched_sid>
    <same_source_ip />
    <field name="dst_port">3389</field>
    <description>NetFlow: Multiple RDP connections from $(src_ip) - possible lateral movement</description>
    <group>lateral_movement,rdp,</group>
    <mitre>
      <id>T1021.001</id>
    </mitre>
  </rule>

  <!-- Cryptocurrency Mining -->
  
  <rule id="220070" level="7">
    <if_sid>220001</if_sid>
    <field name="dst_port" type="pcre2">^(3333|4444|5555|8333|9332|14444)$</field>
    <description>NetFlow: Traffic to cryptocurrency mining pool port $(dst_port) from $(src_ip)</description>
    <group>cryptomining,malware,</group>
    <mitre>
      <id>T1496</id>
    </mitre>
  </rule>

  <!-- Tor/VPN Detection -->
  
  <rule id="220080" level="5">
    <if_sid>220001</if_sid>
    <field name="dst_port">9001</field>
    <description>NetFlow: Possible Tor traffic detected from $(src_ip)</description>
    <group>tor,anonymization,</group>
    <mitre>
      <id>T1090.003</id>
    </mitre>
  </rule>

  <rule id="220081" level="5">
    <if_sid>220001</if_sid>
    <field name="dst_port" type="pcre2">^(1194|1723|500|4500)$</field>
    <description>NetFlow: VPN traffic detected on port $(dst_port) from $(src_ip)</description>
    <group>vpn,anonymization,</group>
  </rule>

  <!-- Internal Scanning -->
  
  <rule id="220090" level="6" frequency="30" timeframe="120">
    <if_matched_sid>220001</if_matched_sid>
    <same_source_ip />
    <description>NetFlow: Internal network scanning from $(src_ip) - $(frequency_value) connections</description>
    <group>recon,internal_scan,</group>
    <mitre>
      <id>T1046</id>
    </mitre>
  </rule>

</group>
