<!--
  MikroTik RouterOS Rules for JSON-decoded logs from Fluentd
  
  These rules work with the mikrotik-json decoder
-->

<group name="mikrotik,syslog,authentication,">

  <!-- Base rule for all MikroTik logs -->
  <rule id="100001" level="0">
    <decoded_as>mikrotik-json</decoded_as>
    <description>MikroTik RouterOS log.</description>
  </rule>

  <!-- Authentication Events -->
  
  <rule id="100010" level="3">
    <if_sid>100001</if_sid>
    <field name="mikrotik.full_message">logged in</field>
    <description>MikroTik: User $(mikrotik.parsed.user) logged in from $(mikrotik.parsed.src_ip) via $(mikrotik.parsed.protocol)</description>
    <mitre>
      <id>T1078</id>
    </mitre>
  </rule>

  <rule id="100011" level="5">
    <if_sid>100001</if_sid>
    <field name="mikrotik.full_message">login failure</field>
    <description>MikroTik: Login failure for user $(mikrotik.parsed.user) from $(mikrotik.parsed.src_ip) via $(mikrotik.parsed.protocol)</description>
    <mitre>
      <id>T1110</id>
    </mitre>
  </rule>

  <rule id="100012" level="10" frequency="5" timeframe="120">
    <if_matched_sid>100011</if_matched_sid>
    <same_source_ip />
    <description>MikroTik: Multiple login failures from $(srcip)</description>
    <mitre>
      <id>T1110</id>
    </mitre>
  </rule>

  <rule id="100013" level="12" frequency="10" timeframe="300">
    <if_matched_sid>100011</if_matched_sid>
    <description>MikroTik: Brute force attack detected - $(frequency_value) failed attempts</description>
    <mitre>
      <id>T1110.001</id>
    </mitre>
  </rule>

  <rule id="100014" level="3">
    <if_sid>100001</if_sid>
    <field name="full_message">logged out</field>
    <description>MikroTik: User $(user) logged out</description>
  </rule>

  <!-- User Management - CRITICAL EVENTS -->
  
  <rule id="100020" level="10">
    <if_sid>100001</if_sid>
    <field name="full_message" type="pcre2">user \S+ added by</field>
    <description>MikroTik: CRITICAL - New user account created</description>
    <group>user_management,account_creation,</group>
    <mitre>
      <id>T1136.001</id>
    </mitre>
  </rule>

  <rule id="100021" level="12">
    <if_sid>100020</if_sid>
    <field name="full_message">group=full</field>
    <description>MikroTik: CRITICAL - Admin user created with FULL privileges</description>
    <group>user_management,privilege_escalation,</group>
    <mitre>
      <id>T1136.001</id>
      <id>T1078.003</id>
    </mitre>
  </rule>

  <rule id="100022" level="10">
    <if_sid>100001</if_sid>
    <field name="full_message" type="pcre2">user \S+ removed by</field>
    <description>MikroTik: CRITICAL - User account deleted</description>
    <group>user_management,account_deletion,</group>
    <mitre>
      <id>T1531</id>
    </mitre>
  </rule>

  <rule id="100023" level="9">
    <if_sid>100001</if_sid>
    <field name="full_message" type="pcre2">user \S+ changed by</field>
    <description>MikroTik: CRITICAL - User account modified</description>
    <group>user_management,account_modification,</group>
    <mitre>
      <id>T1098</id>
    </mitre>
  </rule>

  <rule id="100024" level="11">
    <if_sid>100023</if_sid>
    <field name="full_message">disabled=yes</field>
    <description>MikroTik: CRITICAL - User account DISABLED</description>
    <group>user_management,account_disabled,</group>
    <mitre>
      <id>T1531</id>
    </mitre>
  </rule>

  <rule id="100025" level="10">
    <if_sid>100023</if_sid>
    <field name="full_message">disabled=no</field>
    <description>MikroTik: CRITICAL - User account ENABLED</description>
    <group>user_management,account_enabled,</group>
    <mitre>
      <id>T1098</id>
    </mitre>
  </rule>

  <rule id="100026" level="11">
    <if_sid>100023</if_sid>
    <field name="full_message">group=full</field>
    <description>MikroTik: CRITICAL - User promoted to FULL admin privileges</description>
    <group>user_management,privilege_escalation,</group>
    <mitre>
      <id>T1078.003</id>
      <id>T1098</id>
    </mitre>
  </rule>

  <rule id="100027" level="9">
    <if_sid>100001</if_sid>
    <field name="full_message">password changed</field>
    <description>MikroTik: CRITICAL - Password changed for user</description>
    <group>user_management,password_change,</group>
    <mitre>
      <id>T1098</id>
    </mitre>
  </rule>

  <rule id="100028" level="8">
    <if_sid>100023</if_sid>
    <field name="full_message">group=read</field>
    <description>MikroTik: User privileges changed to READ-ONLY</description>
    <group>user_management,privilege_reduction,</group>
  </rule>

  <rule id="100029" level="8">
    <if_sid>100023</if_sid>
    <field name="full_message">group=write</field>
    <description>MikroTik: User privileges changed to WRITE</description>
    <group>user_management,privilege_change,</group>
  </rule>

  <!-- Firewall Rules -->
  
  <rule id="100030" level="8">
    <if_sid>100001</if_sid>
    <field name="full_message">filter rule</field>
    <description>MikroTik: Firewall filter rule modified by $(user) from $(srcip)</description>
    <mitre>
      <id>T1562.004</id>
    </mitre>
  </rule>

  <rule id="100031" level="8">
    <if_sid>100001</if_sid>
    <field name="full_message">raw rule</field>
    <description>MikroTik: Firewall raw rule modified by $(user) from $(srcip)</description>
    <mitre>
      <id>T1562.004</id>
    </mitre>
  </rule>

  <rule id="100032" level="10" frequency="3" timeframe="60">
    <if_matched_sid>100030</if_matched_sid>
    <same_user />
    <description>MikroTik: Multiple firewall rule changes by $(user)</description>
    <mitre>
      <id>T1562.004</id>
    </mitre>
  </rule>

  <!-- VPN Events -->
  
  <rule id="100040" level="3">
    <if_sid>100001</if_sid>
    <field name="full_message">wireguard</field>
    <description>MikroTik: WireGuard VPN activity - $(user) from $(srcip)</description>
  </rule>

  <rule id="100041" level="3">
    <if_sid>100001</if_sid>
    <field name="full_message">ovpn</field>
    <description>MikroTik: OpenVPN activity from $(srcip)</description>
  </rule>

  <rule id="100042" level="3">
    <if_sid>100001</if_sid>
    <field name="full_message">l2tp</field>
    <description>MikroTik: L2TP VPN activity from $(srcip)</description>
  </rule>

  <rule id="100043" level="3">
    <if_sid>100001</if_sid>
    <field name="full_message">ipsec</field>
    <description>MikroTik: IPsec VPN activity from $(srcip)</description>
  </rule>

  <!-- Network Events -->
  
  <rule id="100050" level="2">
    <if_sid>100001</if_sid>
    <field name="full_message">link up</field>
    <description>MikroTik: Network interface link up</description>
  </rule>

  <rule id="100051" level="4">
    <if_sid>100001</if_sid>
    <field name="full_message">link down</field>
    <description>MikroTik: Network interface link down</description>
  </rule>

  <rule id="100052" level="5" frequency="10" timeframe="60">
    <if_matched_sid>100051</if_matched_sid>
    <description>MikroTik: Multiple interface link down events</description>
  </rule>

  <!-- DHCP Events -->
  
  <rule id="100060" level="3">
    <if_sid>100001</if_sid>
    <field name="full_message">dhcp alert</field>
    <description>MikroTik: Rogue DHCP server detected - $(srcip)</description>
    <mitre>
      <id>T1557.002</id>
    </mitre>
  </rule>

  <rule id="100061" level="2">
    <if_sid>100001</if_sid>
    <field name="full_message">assigned</field>
    <description>MikroTik: DHCP address assigned to $(srcip)</description>
  </rule>

</group>
