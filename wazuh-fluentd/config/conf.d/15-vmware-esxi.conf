###################### VMware ESXi Configuration ######################
# Port: 30527 UDP
# Flow:
#   - ALL logs â†’ Wazuh Manager (rules) + Indexer (anki-esxi-*)
#   - Filebeat filters out sensor logs from archives
#   - Agent logs preserved in wazuh-archives-*

<source>
  @type udp
  port 30527
  bind 0.0.0.0
  tag esxi.syslog
  source_address_key source_ip
  <parse>
    @type none
  </parse>
</source>

# Add metadata and enrich
<filter esxi.**>
  @type record_transformer
  enable_ruby true
  <record>
    log_source vmware-esxi
    vendor vmware
    product esxi
    data_source anki-sensor           # Tag for Filebeat filtering
    hostname ${record["source_ip"] || "unknown"}
    "@timestamp" ${time.strftime('%Y-%m-%dT%H:%M:%S.%LZ')}
    full_message ${record["message"]}
    observer { "product": "ESXi", "vendor": "VMware", "type": "hypervisor" }
  </record>
</filter>

# Parse ESXi specific patterns
<filter esxi.**>
  @type parser
  key_name message
  reserve_data true
  inject_key_prefix parsed.
  <parse>
    @type multi_format
    
    # SSH login failure
    <pattern>
      format regexp
      expression /SSH login has failed for '(?<user>[^@]+)@(?<srcip>[^']+)'/
    </pattern>
    
    # SSH session opened
    <pattern>
      format regexp
      expression /SSH session was opened for '(?<user>[^@]+)@(?<srcip>[^']+)'/
    </pattern>
    
    # SSH session closed
    <pattern>
      format regexp
      expression /SSH session was closed for '(?<user>[^@]+)@(?<srcip>[^']+)'/
    </pattern>
    
    # VM operations
    <pattern>
      format regexp
      expression /(?<vm>[^\s]+) on\s+(?<esxi_host>[^\s]+) in (?<datacenter>[^\s]+) (?<action>has powered on|is powered off|is suspended)/
    </pattern>
    
    # VM created
    <pattern>
      format regexp
      expression /Created virtual machine (?<vm>[^\s]+) on (?<esxi_host>[^\s]+)/
    </pattern>
    
    # VM removed
    <pattern>
      format regexp
      expression /Removed virtual machine (?<vm>[^\s]+) from (?<esxi_host>[^\s]+)/
    </pattern>
    
    # Account management
    <pattern>
      format regexp
      expression /Account (?<user>[^\s]+) was (?<action>created|deleted|modified) on host (?<esxi_host_target>[^\s]+)/
    </pattern>
    
    # Password changes
    <pattern>
      format regexp
      expression /Password was changed for account (?<user>[^\s]+) on host (?<esxi_host_target>[^\s]+)/
    </pattern>
    
    # File operations
    <pattern>
      format regexp
      expression /File upload to path '(?<path>[^']+)' was initiated/
    </pattern>
    
    <pattern>
      format regexp
      expression /Deletion of file or directory (?<path>[^\s]+) from (?<disk>[^\s]+) was initiated/
    </pattern>
  </parse>
</filter>

# Send ALL logs to BOTH Wazuh Manager and Indexer
<match esxi.**>
  @type copy
  
  # To Wazuh Manager for rule processing
  <store>
    @type tcp
    
    host "#{ENV['WAZUH_MANAGER_HOST'] || 'wazuh-manager'}"
    port "#{ENV['WAZUH_MANAGER_PORT'] || '1533'}"
    
    <format>
      @type json
    </format>
    
    <buffer>
      @type file
      path /fluentd/buffer/esxi-wazuh
      flush_mode interval
      flush_interval 5s
      retry_type exponential_backoff
      retry_wait 2s
      retry_max_interval 60s
    </buffer>
  </store>
  
  # To Indexer for device-specific index
  <store>
    @type opensearch
    
    host "#{ENV['INDEXER_HOST'] || 'wazuh-indexer'}"
    port "#{ENV['INDEXER_PORT'] || '9200'}"
    scheme https
    ssl_verify false
    ssl_version TLSv1_2
    
    user "#{ENV['INDEXER_USERNAME']}"
    password "#{ENV['INDEXER_PASSWORD']}"
    
    index_name anki-esxi-%Y.%m.%d
    type_name _doc
    
    <buffer tag, time>
      @type file
      path /fluentd/buffer/esxi-indexer
      timekey 60s
      timekey_wait 10s
      flush_mode interval
      flush_interval 10s
      retry_type exponential_backoff
      retry_wait 2s
      retry_max_interval 300s
      retry_timeout 24h
      chunk_limit_size 8MB
      total_limit_size 1GB
      overflow_action drop_oldest_chunk
      compress gzip
    </buffer>
    
    <secondary>
      @type file
      path /fluentd/failed_records/esxi-indexer
    </secondary>
  </store>
</match>
