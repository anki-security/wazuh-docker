{
  "name": "ESXi - VM Operations",
  "type": "monitor",
  "monitor_type": "query_level_monitor",
  "enabled": true,
  "schedule": {
    "period": {
      "interval": 5,
      "unit": "MINUTES"
    }
  },
  "inputs": [{
    "search": {
      "indices": ["anki-vmware-esxi-*"],
      "query": {
        "size": 20,
        "query": {
          "bool": {
            "must": [
              { "match": { "log_source": "vmware-esxi" }},
              { 
                "bool": {
                  "should": [
                    { "match_phrase": { "event.action": "vm-powered-off" }},
                    { "match_phrase": { "event.action": "vm-powered-on" }},
                    { "match_phrase": { "event.action": "vm-created" }},
                    { "match_phrase": { "event.action": "vm-removed" }},
                    { "match_phrase": { "event.action": "vm-shutdown" }},
                    { "match_phrase": { "event.action": "vm-reboot" }}
                  ],
                  "minimum_should_match": 1
                }
              }
            ],
            "filter": [{
              "range": {
                "@timestamp": {
                  "gte": "{{period_end}}||-5m",
                  "lte": "{{period_end}}",
                  "format": "epoch_millis"
                }
              }
            }]
          }
        },
        "aggs": {
          "by_action": {
            "terms": {
              "field": "event.action.keyword",
              "size": 10
            }
          },
          "by_vm": {
            "terms": {
              "field": "vm.name.keyword",
              "size": 10
            }
          },
          "by_host": {
            "terms": {
              "field": "esxi.host.keyword",
              "size": 5
            }
          }
        }
      }
    }
  }],
  "triggers": [{
    "query_level_trigger": {
      "name": "VM operations detected",
      "severity": "3",
      "condition": {
        "script": {
          "source": "ctx.results[0].hits.total.value > 0",
          "lang": "painless"
        }
      },
      "actions": [{
        "name": "Log VM Operations",
        "destination_id": "{{DESTINATION_ID}}",
        "message_template": {
          "source": "üñ•Ô∏è ESXi VM Operations\n\n*Count:* {{ctx.results.0.hits.total.value}}\n*Time:* {{ctx.periodEnd}}\n*Monitor:* {{ctx.monitor.name}}\n\n*Actions:*\n{{#ctx.results.0.aggregations.by_action.buckets}}\n- {{key}}: {{doc_count}} times\n{{/ctx.results.0.aggregations.by_action.buckets}}\n\n*VMs:*\n{{#ctx.results.0.aggregations.by_vm.buckets}}\n- {{key}}: {{doc_count}} operations\n{{/ctx.results.0.aggregations.by_vm.buckets}}\n\n*ESXi Hosts:*\n{{#ctx.results.0.aggregations.by_host.buckets}}\n- {{key}}: {{doc_count}} operations\n{{/ctx.results.0.aggregations.by_host.buckets}}",
          "lang": "mustache"
        },
        "throttle_enabled": true,
        "throttle": {
          "value": 15,
          "unit": "MINUTES"
        },
        "subject_template": {
          "source": "ESXi VM Operations: {{ctx.results.0.hits.total.value}} events",
          "lang": "mustache"
        }
      }]
    }
  }]
}
