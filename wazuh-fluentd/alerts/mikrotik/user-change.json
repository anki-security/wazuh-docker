{
  "name": "MikroTik - User Account Change",
  "type": "monitor",
  "monitor_type": "query_level_monitor",
  "enabled": true,
  "schedule": {
    "period": {
      "interval": 1,
      "unit": "MINUTES"
    }
  },
  "inputs": [{
    "search": {
      "indices": ["anki-mikrotik-*"],
      "query": {
        "size": 10,
        "query": {
          "bool": {
            "must": [
              { "match": { "log_source": "mikrotik" }},
              { 
                "bool": {
                  "should": [
                    { "match_phrase": { "message": "user added" }},
                    { "match_phrase": { "message": "user removed" }},
                    { "match_phrase": { "message": "user changed" }},
                    { "match_phrase": { "message": "password changed" }}
                  ],
                  "minimum_should_match": 1
                }
              }
            ],
            "filter": [{
              "range": {
                "@timestamp": {
                  "gte": "{{period_end}}||-1m",
                  "lte": "{{period_end}}",
                  "format": "epoch_millis"
                }
              }
            }]
          }
        },
        "aggs": {
          "by_admin": {
            "terms": {
              "field": "user.name.keyword",
              "size": 5
            }
          }
        }
      }
    }
  }],
  "triggers": [{
    "query_level_trigger": {
      "name": "User account modified",
      "severity": "2",
      "condition": {
        "script": {
          "source": "ctx.results[0].hits.total.value > 0",
          "lang": "painless"
        }
      },
      "actions": [{
        "name": "Notify Security Team",
        "destination_id": "{{DESTINATION_ID}}",
        "message_template": {
          "source": "ðŸ‘¤ MikroTik User Account Change Detected\n\n*Count:* {{ctx.results.0.hits.total.value}}\n*Time:* {{ctx.periodEnd}}\n*Monitor:* {{ctx.monitor.name}}\n\n*Modified by:*\n{{#ctx.results.0.aggregations.by_admin.buckets}}\n- {{key}}: {{doc_count}} changes\n{{/ctx.results.0.aggregations.by_admin.buckets}}\n\n*Recent Changes:*\n{{#ctx.results.0.hits.hits}}\n- {{_source.@timestamp}}: {{_source.message}}\n{{/ctx.results.0.hits.hits}}",
          "lang": "mustache"
        },
        "throttle_enabled": true,
        "throttle": {
          "value": 5,
          "unit": "MINUTES"
        },
        "subject_template": {
          "source": "MikroTik User Account Change: {{ctx.results.0.hits.total.value}} events",
          "lang": "mustache"
        }
      }]
    }
  }]
}
