{
  "name": "MikroTik - VPN Connection Events",
  "type": "monitor",
  "monitor_type": "query_level_monitor",
  "enabled": true,
  "schedule": {
    "period": {
      "interval": 5,
      "unit": "MINUTES"
    }
  },
  "inputs": [{
    "search": {
      "indices": ["anki-mikrotik-*"],
      "query": {
        "size": 20,
        "query": {
          "bool": {
            "must": [
              { "match": { "log_source": "mikrotik" }},
              { 
                "bool": {
                  "should": [
                    { "match_phrase": { "message": "wireguard" }},
                    { "match_phrase": { "message": "ovpn" }},
                    { "match_phrase": { "message": "l2tp" }},
                    { "match_phrase": { "message": "pptp" }},
                    { "match_phrase": { "message": "ipsec" }}
                  ],
                  "minimum_should_match": 1
                }
              }
            ],
            "filter": [{
              "range": {
                "@timestamp": {
                  "gte": "{{period_end}}||-5m",
                  "lte": "{{period_end}}",
                  "format": "epoch_millis"
                }
              }
            }]
          }
        },
        "aggs": {
          "by_source_ip": {
            "terms": {
              "field": "source.ip",
              "size": 10
            }
          },
          "by_user": {
            "terms": {
              "field": "user.name.keyword",
              "size": 10
            }
          }
        }
      }
    }
  }],
  "triggers": [{
    "query_level_trigger": {
      "name": "VPN activity detected",
      "severity": "3",
      "condition": {
        "script": {
          "source": "ctx.results[0].hits.total.value > 0",
          "lang": "painless"
        }
      },
      "actions": [{
        "name": "Log VPN Activity",
        "destination_id": "{{DESTINATION_ID}}",
        "message_template": {
          "source": "üîê MikroTik VPN Activity\n\n*Count:* {{ctx.results.0.hits.total.value}}\n*Time:* {{ctx.periodEnd}}\n*Monitor:* {{ctx.monitor.name}}\n\n*Source IPs:*\n{{#ctx.results.0.aggregations.by_source_ip.buckets}}\n- {{key}}: {{doc_count}} connections\n{{/ctx.results.0.aggregations.by_source_ip.buckets}}\n\n*Users:*\n{{#ctx.results.0.aggregations.by_user.buckets}}\n- {{key}}: {{doc_count}} connections\n{{/ctx.results.0.aggregations.by_user.buckets}}",
          "lang": "mustache"
        },
        "throttle_enabled": true,
        "throttle": {
          "value": 15,
          "unit": "MINUTES"
        },
        "subject_template": {
          "source": "MikroTik VPN Activity: {{ctx.results.0.hits.total.value}} events",
          "lang": "mustache"
        }
      }]
    }
  }]
}
