{
  "name": "MikroTik - Login Failure",
  "type": "monitor",
  "monitor_type": "query_level_monitor",
  "enabled": true,
  "schedule": {
    "period": {
      "interval": 1,
      "unit": "MINUTES"
    }
  },
  "inputs": [{
    "search": {
      "indices": ["anki-mikrotik-*"],
      "query": {
        "size": 0,
        "query": {
          "bool": {
            "must": [
              { "match": { "log_source": "mikrotik" }},
              { "match_phrase": { "message": "login failure" }}
            ],
            "filter": [{
              "range": {
                "@timestamp": {
                  "gte": "{{period_end}}||-1m",
                  "lte": "{{period_end}}",
                  "format": "epoch_millis"
                }
              }
            }]
          }
        },
        "aggs": {
          "by_source_ip": {
            "terms": {
              "field": "source.ip",
              "size": 10
            }
          },
          "by_user": {
            "terms": {
              "field": "user.name.keyword",
              "size": 10
            }
          }
        }
      }
    }
  }],
  "triggers": [{
    "query_level_trigger": {
      "name": "High login failures",
      "severity": "2",
      "condition": {
        "script": {
          "source": "ctx.results[0].hits.total.value > 5",
          "lang": "painless"
        }
      },
      "actions": [{
        "name": "Notify Security Team",
        "destination_id": "{{DESTINATION_ID}}",
        "message_template": {
          "source": "ðŸš¨ MikroTik Login Failures Detected\n\n*Count:* {{ctx.results.0.hits.total.value}}\n*Time:* {{ctx.periodEnd}}\n*Monitor:* {{ctx.monitor.name}}\n\n*Top Source IPs:*\n{{#ctx.results.0.aggregations.by_source_ip.buckets}}\n- {{key}}: {{doc_count}} attempts\n{{/ctx.results.0.aggregations.by_source_ip.buckets}}\n\n*Top Users:*\n{{#ctx.results.0.aggregations.by_user.buckets}}\n- {{key}}: {{doc_count}} attempts\n{{/ctx.results.0.aggregations.by_user.buckets}}",
          "lang": "mustache"
        },
        "throttle_enabled": true,
        "throttle": {
          "value": 10,
          "unit": "MINUTES"
        },
        "subject_template": {
          "source": "MikroTik Login Failures: {{ctx.results.0.hits.total.value}} attempts",
          "lang": "mustache"
        }
      }]
    }
  }]
}
