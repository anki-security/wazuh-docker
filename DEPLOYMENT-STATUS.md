# Deployment Status - Custom Rules & Decoders

## âœ… Code Status: READY

### Files Committed (Latest: 7593070)

**Custom Rules** (in `wazuh-manager/config/rules/`):
- âœ… `mikrotik-rules.xml` - 25 rules (100001-100099)
- âœ… `esxi-rules.xml` - 20 rules (100100-100199)
- âœ… `netflow-rules.xml` - 13 rules (100200-100299)

**Custom Decoders** (in `wazuh-manager/config/decoders/`):
- âœ… `mikrotik-json-decoder.xml`
- âœ… `esxi-json-decoder.xml`
- âœ… `netflow-json-decoder.xml`

**Dockerfile Updated**:
```dockerfile
# Copy custom rules and decoders
COPY --chown=root:wazuh config/rules/*.xml /var/ossec/etc/rules/
COPY --chown=root:wazuh config/decoders/*.xml /var/ossec/etc/decoders/
```

## âŒ Deployment Status: NOT DEPLOYED

### Current Production State

**Deployed Image**: Old version (before commit 7593070)

**What's Missing in Production**:
```bash
# Current state in k8s cluster:
/var/ossec/etc/rules/
â”œâ”€â”€ custom_rules.xml              âœ… (exists)
â”œâ”€â”€ linux_hardening_rules.xml     âœ… (exists)
â”œâ”€â”€ mikrotik-rules.xml            âŒ MISSING
â”œâ”€â”€ esxi-rules.xml                âŒ MISSING
â””â”€â”€ netflow-rules.xml             âŒ MISSING

/var/ossec/etc/decoders/
â”œâ”€â”€ mikrotik_decoders.xml         âœ… (built-in, for raw syslog)
â”œâ”€â”€ mikrotik-json-decoder.xml     âŒ MISSING
â”œâ”€â”€ esxi-json-decoder.xml         âŒ MISSING
â””â”€â”€ netflow-json-decoder.xml      âŒ MISSING
```

**Impact**:
- ğŸŸ¡ MikroTik logs: Decoded by built-in decoders BUT no alerts (no rules)
- ğŸ”´ ESXi logs: NOT decoded, no alerts
- ğŸ”´ NetFlow logs: NOT decoded, no alerts

## ğŸš€ Deployment Steps

### Option 1: GitHub Actions (Recommended)

1. **Trigger Build Workflow**:
   ```bash
   # Go to GitHub Actions
   # Select "Build and Push Wazuh Docker Images"
   # Click "Run workflow"
   # Select: bump_type = "patch" (1.0.0 â†’ 1.0.1)
   # Check: push_images = true
   ```

2. **Wait for Build** (~10-15 minutes):
   - Builds wazuh-manager with custom rules/decoders
   - Pushes to `ghcr.io/anki-security/wazuh-manager:1.0.1`
   - Also tags as `:latest`

3. **Update Kubernetes**:
   ```bash
   # Update your Helm values or StatefulSet to use new image:
   image: ghcr.io/anki-security/wazuh-manager:1.0.1
   # OR
   image: ghcr.io/anki-security/wazuh-manager:latest
   
   # Restart pods
   kubectl rollout restart statefulset wazuh-manager -n client1
   kubectl rollout restart statefulset wazuh-manager -n client2
   ```

### Option 2: Manual Local Build

1. **Build Image**:
   ```bash
   cd wazuh-manager
   docker build -t ghcr.io/anki-security/wazuh-manager:1.1.0 .
   ```

2. **Push to Registry**:
   ```bash
   docker push ghcr.io/anki-security/wazuh-manager:1.1.0
   ```

3. **Update Kubernetes** (same as Option 1, step 3)

## âœ… Verification After Deployment

### 1. Check Files Exist

```bash
# Check rules
kubectl exec wazuh-manager-0 -n client1 -- ls -la /var/ossec/etc/rules/
# Should show: mikrotik-rules.xml, esxi-rules.xml, netflow-rules.xml

# Check decoders
kubectl exec wazuh-manager-0 -n client1 -- ls -la /var/ossec/etc/decoders/
# Should show: mikrotik-json-decoder.xml, esxi-json-decoder.xml, netflow-json-decoder.xml
```

### 2. Verify Rules Loaded

```bash
# Check Wazuh logs for rule loading
kubectl logs wazuh-manager-0 -n client1 | grep -i "rules loaded"
kubectl logs wazuh-manager-0 -n client1 | grep -i "mikrotik"
```

### 3. Test with Sample Log

```bash
# Send test MikroTik log via Fluentd
# Should generate alert with rule 100020-100029
```

## ğŸ“Š Expected Results After Deployment

### MikroTik Logs
- âœ… Decoded by `mikrotik-json-decoder.xml`
- âœ… Alerts generated by rules 100001-100099
- âœ… CRITICAL user management events trigger high-level alerts

### ESXi Logs
- âœ… Decoded by `esxi-json-decoder.xml`
- âœ… Alerts generated by rules 100100-100199
- âœ… VM operations, host changes tracked

### NetFlow Logs
- âœ… Decoded by `netflow-json-decoder.xml`
- âœ… Alerts generated by rules 100200-100299
- âœ… Port scanning, data exfiltration, lateral movement detected

## ğŸ“ Current Versions

- **Code Version**: 1.1.0 (wazuh-manager/VERSION)
- **Deployed Version**: 1.0.0 (old, needs update)
- **Target Version**: 1.1.0 (after rebuild)

## ğŸ¯ Action Required

**YOU NEED TO REBUILD AND REDEPLOY THE WAZUH-MANAGER IMAGE**

The code is ready, but the Docker image in your Kubernetes cluster is outdated and doesn't include the custom rules and decoders.

**Recommended**: Use GitHub Actions workflow to build and push version 1.1.0
